# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a comprehensive weather data analysis project that calculates evaporation rates and power generation potential from weather data using rigorous thermodynamic equations. The application:

1. Fetches weather data from the Open-Meteo API for the selected location (currently New York City)
2. Performs unit conversions and data transformations (temperature to Kelvin, wind speed to m/s, humidity to fractions)
3. Calculates evaporation rates using psychrometric equations with thermodynamic constants
4. Computes power per area based on humidity differentials and evaporation rates
5. Creates sophisticated time series visualizations with rolling averages and date filtering
6. Exports charts as PDFs and calculates total annual energy metrics

## Key Files and Architecture

- `main.py`: Core application with comprehensive calculation functions and data processing pipeline
- `fetch.sh`: Shell script to download weather data from Open-Meteo API
- `weather-data.csv`: Downloaded weather dataset with latitude/longitude metadata (generated by `fetch.sh`)
- `pyproject.toml`: Project dependencies and configuration
- `Learning materials/`: Educational resources with formula images and documentation
- Generated outputs: `power_*.pdf` charts and energy calculations

## Application Pipeline and Functions

The application follows a sophisticated functional pipeline with multiple calculation stages:

### 1. Data Loading and Transformation (`get_df()`)

- Loads raw CSV data with coordinate extraction
- Converts units: temperature (°C → K), wind speed (km/h → m/s), humidity (% → fraction)
- Applies timezone corrections (UTC-4 offset)
- Processes data through calculation pipeline

### 2. Thermodynamic Calculations

- `calculate_saturation_vapor_pressure()`: Uses Buck equation for vapor pressure (kPa)
- `calculate_Delta()`: Computes slope of saturation vapor pressure curve using thermodynamic formula
- `calculate_evaporation_rate()`: Applies psychrometric equation with net radiation, wind, and humidity
- Helper functions: `calculate_evaporation_rate_from_kwargs()` for DataFrame integration

### 3. Power Generation Calculations

- `calculate_power_per_area()`: Computes power density from evaporation rates and humidity differentials
- `calculate_power_per_area_from_kwargs()`: DataFrame-compatible wrapper
- Includes energy density calculations (kJ/m²)

### 4. Geographic Data Processing

- `get_lat_lon()`: Extracts coordinates from CSV headers for location-aware visualization

### 5. Advanced Visualization (`plot_df()`)

- Creates time series charts with Altair/Vega-Lite
- Supports rolling average smoothing (1-week windows)
- Date range filtering capabilities
- Automatic PDF export with location-specific titles

## Thermodynamic and Physical Constants

The application uses precise scientific constants for accurate calculations:

### Psychrometric Constants

- `CONVERSION_CONSTANT`: 0.01157 W m day MJ⁻¹ mm⁻¹
- `SPECIFIC_LATENT_HEAT_OF_VAPORIZATION_WATER`: 2448 MJ Mg⁻¹
- `WATER_DENSITY`: 1.0 Mg m⁻³
- `PSYCHROMETRIC_CONSTANT`: 0.067 kPa K⁻¹

### Power Calculation Constants

- `EVAPORATION_CONVERSION_CONSTANT`: 6.42465×10⁻⁴ mol day mm⁻¹ m⁻² s⁻¹
- `IDEAL_GAS_CONSTANT`: 8.314 J mol⁻¹ K⁻¹
- `WATER_VAPOR_GAS_CONSTANT`: 461.5 J kg⁻¹ K⁻¹

## Main Application Features

The `main()` function demonstrates the complete workflow:

- Processes full year of weather data
- Generates multiple visualizations (full year rolling average, specific month detail)
- Calculates and displays total annual energy per area
- Exports charts as PDF files for documentation

## Development Commands

**Install dependencies:**

**Update weather data:**

```bash
./fetch.sh
```

```bash
uv sync
```

**Run the application:**

```bash
uv run python main.py
```

**Development environment (Jupyter):**
The main.py file uses Jupyter cell markers (`# %%`) and can be run interactively.

## Dependencies

- **polars**: DataFrame processing and CSV handling
- **altair**: Data visualization with Vega-Lite
- **vegafusion**: Chart rendering optimization
- **vl-convert-python**: Chart export capabilities
- **ruff**: Code linting and formatting (dev dependency)
- **ipykernel**: Jupyter notebook support (dev dependency)
